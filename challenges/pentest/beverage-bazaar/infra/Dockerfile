FROM debian:bookworm-slim

ENV USER=mdupuis
ENV USER_PASS=SecureShell@PopaCoola
ENV USER_HOME=/home/${USER}
ENV FLAG="24HIUT{Anonymous_FTP_Connection}"

# Install dependencies
RUN apt update && apt install -y \
    vsftpd \
    openssh-server \
    && rm -rf /var/lib/apt/lists/*

# Copy files
COPY vsftpd.conf /etc/vsftpd.conf
COPY PopaCola_Vault /ftp/PopaCola_Vault

# Configure FTP server
RUN mkdir -p /var/run/sshd /ftp /var/run/vsftpd/empty \
    && chmod -R 555 /ftp \
    && useradd -m -s /bin/bash ${USER} \
    && echo "${USER}:${USER_PASS}" | chpasswd
    
# Add secrets
RUN echo ${FLAG} > ${USER_HOME}/flag.txt \
    && chown ${USER}: ${USER_HOME}/flag.txt \
    && sed -i "s/\[CHANGEME\]/$USER_PASS/" /ftp/PopaCola_Vault/03_Communication/01_Internal/Meetings/Meetings_Reports/March/Meeting_Notes_March.md


# Start services
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
