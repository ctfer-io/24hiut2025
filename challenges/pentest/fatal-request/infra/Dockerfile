FROM python:3.10-slim

ENV USER=mdupuis
ENV USER_PASS=SecureShell@PopaCoola
ENV USER_HOME=/home/${USER}
ENV FLAG="24HIUT{Fire_That_Damn_Intern}"

# Install dependencies
RUN apt update && apt install -y \
    vim \
    openssh-server \
    cron \
    && rm -rf /var/lib/apt/lists/*

# Configure ENV
RUN mkdir -p /var/run/sshd ${USER_HOME}/.local /scripts \
    && useradd -m -s /bin/bash ${USER} \
    && echo "${USER}:${USER_PASS}" | chpasswd \
    && chown -R ${USER}: ${USER_HOME}/.local

# Copy necessary files
COPY msg_de_franck.md ${USER_HOME}/msg_de_franck.md
COPY web_grabber.py /scripts/web_grabber.py

# Introduce library vulnerability
RUN chmod 444 /scripts/web_grabber.py \
    && chown ${USER}:${USER} ${USER_HOME}/.local \
    && python3 -m pip install requests \
    && chmod o+w /usr/local/lib/python3.*/site-packages/requests/api.py \
    && echo "* * * * * root python3 /scripts/web_grabber.py" >> /etc/crontab
    
# Add flags
RUN echo ${FLAG} > /root/flag.txt \
    && chmod 600 /root/flag.txt

# Start services
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
