FROM debian:12-slim

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && apt install openssh-server sudo expect coreutils -y

# Setup user

RUN adduser --disabled-password --gecos "" user && \
	echo 'user:password' | chpasswd && \
	ln -sf /dev/null /home/user/.bash_history && \
	echo 'user ALL=(root) NOPASSWD: /bin/awk' > /etc/sudoers.d/user && \
	chmod 0440 /etc/sudoers.d/user

# Setup restricted env
RUN mkdir /usr/local/rbin
COPY ../dist/rbash /usr/local/rbin/rbash
COPY ../dist/rnano /bin/rnano
COPY ../dist/less /bin/less
COPY ../dist/more /bin/more
RUN chmod +x /usr/local/rbin/rbash && \
	usermod -s /usr/local/rbin/rbash user && \
	ln -s /bin/cp /usr/local/rbin/cp && \
	ln -s /bin/less /usr/local/rbin/less && \
	ln -s /bin/rnano /usr/local/rbin/nano && \
	ln -s /bin/ls /usr/local/rbin/ls && \
	ln -s /bin/more /usr/local/rbin/more && \
	ln -s /bin/expect /usr/local/rbin/expect && \
	ln -s /usr/bin/dircolors /usr/local/rbin/dircolors && \
	ln -s /bin/cat /usr/local/rbin/cat && \
	chmod 444 /home/user/.bashrc /home/user/.profile

# Overides all the other localisation settings
RUN echo "export LC_ALL=C" >> /home/user/.bashrc

# Write flag
RUN echo "24HIUT{3XP3C7_7H3_35C4P3_4WK_Y0UR_W4Y_UP}" > /root/flag.txt && \
	chown root:root /root/flag.txt && chmod 400 /root/flag.txt

# Delete motd
RUN rm /etc/motd && touch /etc/motd

# Copy statup file to container and run it.
COPY ../dist/start.sh /root/start.sh
COPY ../dist/start.txt /home/user/.start.txt
RUN chmod +x /root/start.sh
EXPOSE 22
CMD ["/root/start.sh"]
