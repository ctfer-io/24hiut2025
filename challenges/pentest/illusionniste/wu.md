
# Défi "L'Illusionniste"

Nous débarquons sur la machine avec peu d'informations, si ce n'est ce message d'accueil énigmatique :

> Bienvenue dans le défi "L'Illusionniste" \!
>
> Un magicien ne révèle jamais ses secrets, mais parfois les scripts révèlent plus qu'ils ne devraient.
> Quelque chose vous attend sur cette machine, caché derrière des couches d'automatisation.
>
> Les outils sont souvent plus puissants qu'ils n'y paraissent, et certains langages
> peuvent faire bien plus que leur fonction première...
>
> Trouvez votre chemin vers la liberté, puis élevez-vous au-delà des restrictions.
> Le flag vous attend dans la demeure de celui qui contrôle tout, au sommet de ces lieux.
>
> Bonne chance \!

------------------------------------------------------------------------
## Évasion de l'environnement restreint

Lorsque nous tentons de nous déplacer dans d'autres répertoires, la commande nous est refusée : `bash: cd: restricted`. Cela indique clairement que nous sommes dans un **environnement restreint**.

Très bien, commençons par examiner les binaires auxquels nous avons accès. La commande `echo $PATH && ls $_` nous retourne le chemin d'accès aux binaires ainsi que les binaires disponibles : `cat cp dircolors expect less ls more nano rbash`.

Si l'on se réfère au premier paragraphe du message d'accueil, il est fait mention de **scripting** et d'**automatisation**. Parmi les binaires présents, seul `expect` peut servir à cette tâche.

En consultant [gtfobins](https://gtfobins.github.io/gtfobins/expect/), nous apprenons qu'il est possible de s'échapper d'un environnement restreint avec `expect`. Plusieurs méthodes sont disponibles, la plus simple étant d'utiliser directement celle proposée sur gtfobins (Personnellement, je préfère souvent /bin/bash à /bin/sh.) :

```bash
expect -c 'spawn /bin/sh;interact'
```

------------------------------------------------------------------------
## Escalade de privilèges
À ce stade, nous nous sommes échappés de l'environnement restreint. Vérifions maintenant nos droits avec :

```bash
/bin/sudo -l
```

Visiblement, nous pouvons exécuter awk avec les droits root. Mais qu'est-ce qu'awk ? C'est à la fois une commande et un langage de programmation (comme mentionné dans le deuxième paragraphe du message d'accueil).

Sa syntaxe ressemble à ceci : awk 'BEGIN{instruction}'.

Étant donné que nous pouvons l'exécuter avec les droits root, nous devrions être capables d'exécuter un shell en tant que root :

```bash
/bin/sudo /bin/awk 'BEGIN{system("/bin/bash")}'
```

Nous voilà maintenant root, "**celui qui contrôle tout**". Rendons-nous dans sa demeure, c'est-à-dire son répertoire home :

```bash
cd /root
```

Le flag se trouve sous nos yeux :

```bash
cat flag.txt
```

Félicitations.
